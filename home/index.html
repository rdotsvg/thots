<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/home.css">
    <title>thots - Home</title>
</head>
<body>
    <!-- Auth Section -->
    <div id="auth-section">
        <div id="auth-forms">
            <!-- Toggle between sign up and sign in -->
            <div id="signup-form">
                <h3>Join thots</h3>
                <input type="text" id="invite-code" placeholder="Invite code" />
                <input type="text" id="handle" placeholder="Handle (e.g., alice)" />
                <input type="password" id="password" placeholder="Password" />
                <button onclick="handleSignUp()">Sign Up</button>
                <p>Already have an account? <a href="#" onclick="showSignIn()">Sign in</a></p>
            </div>
            
            <div id="signin-form" style="display: none;">
                <h3>Welcome back</h3>
                <input type="text" id="login-handle" placeholder="Handle (e.g., alice)" />
                <input type="password" id="login-password" placeholder="Password" />
                <button onclick="handleSignIn()">Sign In</button>
                <p>Need an account? <a href="#" onclick="showSignUp()">Sign up</a></p>
            </div>
        </div>
        
        <div id="user-info" style="display: none;">
            <span id="current-user"></span>
            <button onclick="handleSignOut()">Sign Out</button>
        </div>
    </div>

    <!-- Post Creation Section -->
    <div id="post-section" style="display: none;">
        <div class="comp">
            <textarea id="post-content" maxlength="100" placeholder="What's on your mind? (max 100 chars)"></textarea>
            <div class="post-actions">
                <button onclick="handleCreatePost()">Thot</button>
                <span id="char-count">0/100</span>
            </div>
        </div>
    </div>

    <!-- Feed Section -->
    <div id="feed-section">
        <div id="posts-container"></div>
    </div>

    <script src="https://esm.sh/@convex-dev/client"></script>
    <script>
        // Convex client - REPLACE with your deployment URL
        // const convex = new ConvexClient('https://your-deployment.convex.cloud');
        
        // Session management
        function getSessionId() {
            return localStorage.getItem('thots_session');
        }
        
        function setSessionId(sessionId) {
            localStorage.setItem('thots_session', sessionId);
        }
        
        function removeSessionId() {
            localStorage.removeItem('thots_session');
        }
        
        // UI toggles
        function showSignUp() {
            document.getElementById('signup-form').style.display = 'block';
            document.getElementById('signin-form').style.display = 'none';
        }
        
        function showSignIn() {
            document.getElementById('signup-form').style.display = 'none';
            document.getElementById('signin-form').style.display = 'block';
        }
        
        // Authentication - REPLACE with actual Convex calls
        async function handleSignUp() {
            try {
                const inviteCode = document.getElementById('invite-code').value.trim();
                const handle = document.getElementById('handle').value.trim();
                const password = document.getElementById('password').value;
                
                // REPLACE with:
                // const result = await convex.mutation('signUp', { inviteCode, handle, password });
                // setSessionId(result.sessionId);
                
                // Demo mode:
                setSessionId('demo_session_' + Date.now());
                showUserSection(handle);
            } catch (error) {
                alert('Sign up failed: ' + error.message);
            }
        }
        
        async function handleSignIn() {
            try {
                const handle = document.getElementById('login-handle').value.trim();
                const password = document.getElementById('login-password').value;
                
                // REPLACE with:
                // const result = await convex.mutation('signIn', { handle, password });
                // setSessionId(result.sessionId);
                
                // Demo mode:
                setSessionId('demo_session_' + Date.now());
                showUserSection(handle.startsWith('@') ? handle : '@' + handle);
            } catch (error) {
                alert('Sign in failed: ' + error.message);
            }
        }
        
        async function handleSignOut() {
            try {
                const sessionId = getSessionId();
                if (sessionId) {
                    // REPLACE with:
                    // await convex.mutation('signOut', { sessionId });
                }
                removeSessionId();
                showAuthSection();
            } catch (error) {
                console.error('Sign out failed:', error);
                removeSessionId();
                showAuthSection();
            }
        }
        
        // Post creation - REPLACE with actual Convex calls
        async function handleCreatePost() {
            try {
                const sessionId = getSessionId();
                const content = document.getElementById('post-content').value.trim();
                
                if (!content) {
                    alert('Post cannot be empty');
                    return;
                }
                
                // REPLACE with:
                // await convex.mutation('createPost', { sessionId, content });
                
                // Demo mode - add to local feed
                addLocalPost(content);
                
                document.getElementById('post-content').value = '';
                updateCharCount();
            } catch (error) {
                alert('Post failed: ' + error.message);
            }
        }
        
        // Feed loading - REPLACE with actual Convex calls
        async function loadFeed() {
            try {
                // REPLACE with:
                // const posts = await convex.query('latestFeed');
                
                // Demo mode - use local storage
                const posts = JSON.parse(localStorage.getItem('thots_posts') || '[]');
                renderPosts(posts);
            } catch (error) {
                console.error('Failed to load feed:', error);
            }
        }
        
        // Render posts using post.svelte ID mapping
        function renderPosts(posts) {
            const container = document.getElementById('posts-container');
            container.innerHTML = '';
            
            posts.forEach(post => {
                const postElement = createPostElement(post);
                container.appendChild(postElement);
            });
        }
        
        // Demo mode - add local post
        function addLocalPost(content) {
            const sessionId = getSessionId();
            const posts = JSON.parse(localStorage.getItem('thots_posts') || '[]');
            
            posts.unshift({
                _id: 'local_' + Date.now(),
                handle: document.getElementById('current-user').textContent || '@user',
                content: content.substring(0, 100),
                createdAt: Date.now()
            });
            
            localStorage.setItem('thots_posts', JSON.stringify(posts.slice(0, 100)));
            renderPosts(posts);
        }
        
        // Create post element matching post.svelte IDs
        function createPostElement(post) {
            const wrapper = document.createElement('div');
            wrapper.style.marginBottom = '16px';
            
            // Use post.svelte ID structure
            wrapper.innerHTML = \`
                <div>
                    <div id="user" class="meta"></div>
                    <div id="time" class="meta"></div>
                    <div id="post" class="post"></div>
                </div>
            \`;
            
            // Map post data to post.svelte IDs
            wrapper.querySelector('#user').textContent = post.handle;      // @alice
            wrapper.querySelector('#time').textContent = formatTime(post.createdAt);  // "2h"
            wrapper.querySelector('#post').textContent = post.content;      // content
            
            return wrapper;
        }
        
        // Time formatting helper
        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(mins / 60);
            const days = Math.floor(hours / 24);
            
            if (mins < 1) return 'just now';
            if (mins < 60) return mins + 'm';
            if (hours < 24) return hours + 'h';
            if (days < 7) return days + 'd';
            return new Date(timestamp).toLocaleDateString();
        }
        
        // Character counter for posts
        function updateCharCount() {
            const content = document.getElementById('post-content').value;
            const count = content.length;
            document.getElementById('char-count').textContent = count + '/100';
            
            // Visual warning at 100 chars
            const counter = document.getElementById('char-count');
            if (count >= 100) {
                counter.style.color = '#ff6b6b';
            } else {
                counter.style.color = '#808080';
            }
        }
        
        // UI state management
        function showAuthSection() {
            document.getElementById('auth-forms').style.display = 'block';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('post-section').style.display = 'none';
            document.getElementById('feed-section').style.display = 'none';
        }
        
        function showUserSection(handle) {
            document.getElementById('auth-forms').style.display = 'none';
            document.getElementById('user-info').style.display = 'block';
            document.getElementById('current-user').textContent = handle;
            document.getElementById('post-section').style.display = 'block';
            document.getElementById('feed-section').style.display = 'block';
            
            // Load initial feed
            loadFeed();
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Character counter
            document.getElementById('post-content').addEventListener('input', updateCharCount);
            
            // Check existing session
            const sessionId = getSessionId();
            if (sessionId) {
                // In production, validate session with Convex
                // REPLACE with:
                // const valid = await convex.query('validateSession', { sessionId });
                // if (valid.valid) showUserSection();
                
                // Demo mode:
                showUserSection(localStorage.getItem('thots_handle') || '@demo');
            } else {
                showAuthSection();
            }
        });
    </script>
</body>
</html>